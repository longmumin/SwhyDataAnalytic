<!DOCTYPE html>
<html lang="en">

<!--引用静态文件 -->
{% load staticfiles %}
    <head>
        <meta charset="utf-8">
        <!--允许全屏-->
        <meta content="yes" name="apple-mobile-web-app-capable">
        <meta content="yes" name="apple-touch-fullscreen">
        <meta content="telephone=no,email=no" name="format-detection">
        <script src="{% static 'js/jquery-3.2.1.min.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/public.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/flexible.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/flexible.debug.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/flexible_css.debug.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/ui_datepicker_jquery-ui.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/jquery.mloading.js' %}" type="text/javascript"></script>
        <script src="{% static 'js/fm.selectator.jquery.js' %}" type="text/javascript"></script>

        <title>申万宏源FICC</title>
        <link href="{% static 'css/quotes.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'css/jquery.mloading.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'css/jquery_datepicker.css' %}" rel="stylesheet">
        <link href="{% static 'css/fm.selectator.jquery.css' %}" rel="stylesheet">
{#        <link href="{% static 'css/bootstrap.flatly.css' %}" rel="stylesheet">#}


        <style>
            html,body{
                height: 100vh;
                background-color: #050505;
            }
        </style>
    </head>

    <body>

{#    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">#}
{#        <a class="navbar-brand"><img src="/static/image/swhylogo.png" style="width:100%; float:left;"></a>#}
{#        <h2 class="navbar-brand" style="font-size: 20px">申万宏源证券有限公司--期权报价</h2>#}
{#        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">#}
{#            <span class="navbar-toggler-icon"></span>#}
{#        </button>#}
{##}
{#        <div class="collapse navbar-collapse" id="navbarColor01">#}
{##}
{#                    <label style="color: #5b80b2; margin-left: .6rem"> 交易所</label>#}
{#                    <select id="ExchangeSelect" class="custom-select">#}
{#                        <option value="00" id="id_exchange">--选择交易所--</option>#}
{#                    </select>#}
{##}
{#                    <label style="color: #5b80b2;margin-left: .3rem"> 挂钩标的</label>#}
{#                    <select id="ContractListSelect" class="custom-select">#}
{#                        <option value="00" id='id_contract'>--选择期货--</option>#}
{#                    </select>#}
{##}
{##}
{#                    <label style="color: #5b80b2">期限</label>#}
{#                    <select id="qixian" class="custom-select" name="qixianSelect">#}
{#                        <option value="01">--期限--</option>#}
{#                    </select>#}
{##}
{#        </div>#}
{#    </nav>#}
{##}
{#        <div class="html_content">#}
{#            <div class="item-section" data-repeat="sections">#}
{##}
{#                <table id="optionTable" class="table table-hover">#}
{#                    <tr id="tableTitle">#}
{#                        <th class="table-th" colspan="2" style = "background-color: red">看涨</th>#}
{#                        <th class="table-th" id = 'instrument' style = "background-color: black">forward</th>#}
{#                        <th class="table-th" colspan="2" style = "background-color: #008B00">看跌</th>#}
{#                    </tr>#}
{##}
{#                    <tr id="tableTitle">#}
{#                        <th class="table-th">买价</th>#}
{#                        <th class="table-th">卖价</th>#}
{#                        <th class="table-th">行权价</th>#}
{#                        <th class="table-th">买价</th>#}
{#                        <th class="table-th">卖价</th>#}
{#                    </tr>#}
{#                </table>#}

{#            </div>>#}
{#        </div>>#}

        <div class="html_content">
            <div class="item-section" data-repeat="sections">
                <div class="item-section_header">
                    <h2><img src="/static/image/swhylogo.png" style="width:25%; float:left;"></h2>
                     <h2>申万宏源证券有限公司--期权报价</h2>
                </div>


                <div class="calender-body_left">
                    <label style="color: #5b80b2; margin-left: .6rem"> 交易所</label>
                    <select id="ExchangeSelect" style="margin-top: 0.6rem; height: 0.6rem; width: 2rem; margin-right: .1rem">
                        <option value="00" id="id_exchange">--选择交易所--</option>
                    </select>

                    <label style="color: #5b80b2;margin-left: .3rem"> 挂钩标的</label>
                    <select id="ContractListSelect" style="margin-top: 0.6rem; height: 0.6rem; width: 2.5rem; margin-right: .1rem">
                        <option value="00" id='id_contract'>--选择期货--</option>
                    </select>
                </div>
                <div action="" class="calender-body_right" style="font-size: 20px">
                    <label style="color: #5b80b2">期限</label>
                    <select id="qixian" style="margin-top: 0.6rem; height: 0.6rem; width: 2rem; margin-right: .1rem" name="qixianSelect">
                        <option value="01">--期限--</option>
                    </select>
                </div>


                <table id="optionTable" class="table">
                    <tr id="tableTitle">
                        <th class="table-th" colspan="2" style = "background-color: red">看涨</th>
                        <th class="table-th" id = 'instrument' style = "background-color: black">forward</th>
                        <th class="table-th" colspan="2" style = "background-color: #008B00">看跌</th>
                    </tr>

                    <tr id="tableTitle">
                        <th class="table-th">买价</th>
                        <th class="table-th">卖价</th>
                        <th class="table-th">行权价</th>
                        <th class="table-th">买价</th>
                        <th class="table-th">卖价</th>
                    </tr>
                </table>

            </div>>
        </div>>


        <script>

             $(function() {

                 //进度条
                 $('body').mLoading({
                    text:"加载T型报价"//加载文字，默认值：加载中...
                 });

                 //获取合约号
                 var instrument = window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1, window.location.pathname.length)

                 //初始化选择框
                 init(instrument);

                 var qixian = 1;
                 //加载报价数据
                 loadQuotesData(qixian, instrument);

                 //刷新页面，每隔5秒刷新一次数据
                 //setInterval(refreshQuoteData(instrument),5000);
                 window.setInterval(refreshQuoteData,5000,instrument);

             });

             function init(instrument) {
                 //下拉框初始显示当前合约及所在交易所
                 document.getElementById("id_contract").innerHTML="- "+instrument.substr(0, instrument.indexOf('.'))+" -";
                 document.getElementById("id_exchange").innerHTML="- "+instrument.substr(-3, 3)+" -";

                 //初始合约名称下拉框
                 $("#qixian").empty();
                 selectInit($("#ExchangeSelect"),'quoteexchanges');

                 selectInit($("#qixian"),'qixian');


                 //绑定交易所下拉框
                 $("#ExchangeSelect").change(function(){
                     var exchanges = $(this).children('option:selected').text();
                     $("#ContractListSelect option:not(:first)").remove();
                     selectInit($("#ContractListSelect"),'contractname'+ exchanges);
                 });

                 //绑定合约下拉框
                 $("#ContractListSelect").change(function jump(){
                     var contractName = $(this).children('option:selected').text();
                     window.location.pathname='/quotes/TQuotes/' + contractName;
                 });

                 //绑定期限下拉框及日期
                 $("#qixian").change(function(){
                     $('body').mLoading({
                         text:"加载T型报价",//加载文字，默认值：加载中...
                     });
                     $('#optionTable tr:gt(1)').remove();
                     var qixian = $(this).children('option:selected').val();

                     loadQuotesData(qixian, instrument);

                 });
             }

             /***** 数据获取函数 *****/
             function loadQuotesData(qixian, instrument){
                 var url = '/quotes/TQuotes/loadTQuotes/' + instrument;
                 $.ajax({
                     type: 'POST',
                     data:{
                         "qixian":qixian,
                         "instrument":instrument
                     },
                     dataType: 'json',
                     url: url,
                     success: loadData,
                     error : errorInfo,
                     //采用异步
                     async: true
                 });
             }

             var loadData = function(data){
                //更新数据
                console.log(data.quoteData);
                //获取合约号
                var instrument = window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1, window.location.pathname.length);
                itemId = instrument.substr(0, instrument.indexOf('.'));

                //根据现价和昨收价，给报价上色
                 forward = parseFloat(data.forward)
                 lastPrice = parseFloat(data.lastPrice)
                 if(forward > lastPrice) {
                     var callColor = 'red';
                     var putColor = '#008B00'
                 }
                 else if(forward < lastPrice){
                     var callColor = '#008B00';
                     var putColor = 'red'
                 }
                 else if(forward == lastPrice){
                     var callColor = 'white';
                     var putColor = 'white'
                 }

                $.each(data.quoteData, function(i, item){
                     var newRow = $('<tr id="'+itemId+'" style="background-color:#050505">' +
                         '<td class="table-td" id="'+itemId+'pricingCallAsk"  style="color:' + callColor + '">' + item[1].pricingCallAsk + '</td>' +
                         '<td class="table-td" id="'+itemId+'pricingCallBid" style="color:' + callColor + '">' + item[1].pricingCallBid + '</td>' +
                         '<td class="table-td" style="background-color: #2B2B2B" id="'+itemId+'item">' + item[0] + '</td>' +
                         '<td class="table-td" id="'+itemId+'pricingPutAsk" style="color:' + putColor + '">' + item[1].pricingPutAsk + '</td>' +
                         '<td class="table-td" id="'+itemId+'pricingPutBid" style="color:' + putColor + '">' + item[1].pricingPutBid + '</td>').hide().fadeIn(1000);
                     $('#optionTable').append(newRow);
                });
                changeFont('instrument', data.forward, 'White');
                $('body').mLoading("hide");
             };

             /***** 页面自动刷新函数 *****/
             function refreshQuoteData(instrument) {
                 var url = '/quotes/TQuotes/updateTQuotes/' + instrument;
                 var qixian = $("#qixian").children('option:selected').val();

                 $.ajax({
                     type: 'POST',
                     data:{
                         "qixian":qixian,

                         "instrument":instrument
                     },
                     dataType: 'json',
                     url: url,
                     success: updateData,
                     error : errorInfo,
                     //采用异步
                     async: true
                 });
             }

            var updateData = function(data){
                 /*
                //更新数据
                console.log(data);
                $.each(data, function(i, item) {
                    itemId = item[0].substr(0, item[0].indexOf('.'));
                    if(item[1].forward < item[1].lastPrice)
                         fontColor = 'Green'
                     else if(item[1].forward > item[1].lastPrice)
                         fontColor = 'Red'
                     else if(item[1].forward == item[1].lastPrice)
                         fontColor = 'White'
                    changeFont(itemId+'forward', item[1].forward, fontColor);
                    changeFont(itemId+'pricingAsk', item[1].pricingAsk, fontColor);
                    changeFont(itemId+'pricingBid', item[1].pricingBid, fontColor);
                });
                */
                changeFont('instrument', data.forward, 'White');
            };

            // 更改内容渐变字体,#####需要判断修改的数值是否有变化#####
            function changeFont(id, text, fontColor) {
                //如果字段值有变化，触发修改动作
                if($("#"+id).text() != text){
                    $("#"+id).animate({ opacity: '0'}, 500, function () {
		                $(this).text(text).css("color",fontColor);
	                }).animate({ opacity: '1'}, 500);
                }
            }
            //错误信息处理界面
            var errorInfo = function(msg){
                //关闭进度条
                $('body').mLoading("hide");
            };

            //修改setInterval函数，令setinterval函数支持输入参数，标准使用格式window.setInterval(refreshQuoteData,5000,instrument)，在响应时间后可以跟多个参数
            var __sto = setInterval;
            window.setInterval = function(callback,timeout,param){
                var args = Array.prototype.slice.call(arguments,2);
                var _cb = function(){
                    callback.apply(null,args);
                }
                __sto(_cb,timeout);
            }

        </script>


    </body>


</html>